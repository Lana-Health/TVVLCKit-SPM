name: Update TVVLCKit Framework

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  check-and-update:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for latest VLCKit release
        id: check-version
        run: |
          # Fetch the latest release info from VLCKit GitLab
          echo "Checking for latest VLCKit release..."

          # Get latest release tag from GitLab API
          LATEST_RELEASE=$(curl -s "https://code.videolan.org/api/v4/projects/videolan%2FVLCKit/releases" | jq -r '.[0].tag_name')
          echo "Latest VLCKit version: $LATEST_RELEASE"

          # Get current version from Package.swift
          CURRENT_VERSION=$(grep -o 'download/v[0-9.]*' Package.swift | head -1 | sed 's/download\/v//')
          echo "Current version: $CURRENT_VERSION"

          echo "latest_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "current_version=v$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ "$LATEST_RELEASE" != "v$CURRENT_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Update available: $CURRENT_VERSION -> $LATEST_RELEASE"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Already up to date"
          fi

      - name: Download and prepare new framework
        if: steps.check-version.outputs.update_available == 'true'
        id: download
        run: |
          VERSION=${{ steps.check-version.outputs.latest_version }}
          VERSION_NUM=${VERSION#v}

          echo "Downloading TVVLCKit $VERSION..."

          # Download the framework from VLCKit releases
          # Note: Adjust this URL based on actual VLCKit release structure
          DOWNLOAD_URL="https://code.videolan.org/videolan/VLCKit/-/jobs/artifacts/$VERSION/download?job=tvos"

          # Alternative: If they provide direct framework downloads
          # DOWNLOAD_URL="https://download.videolan.org/pub/cocoapods/prod/TVVLCKit-$VERSION_NUM.tar.xz"

          mkdir -p temp_download
          cd temp_download

          # Download the artifact
          curl -L -o framework.zip "$DOWNLOAD_URL" || {
            echo "‚ùå Failed to download from primary URL"
            # Fallback or alternative download method
            exit 1
          }

          # Extract and locate TVVLCKit.xcframework
          unzip -q framework.zip || tar -xf framework.zip

          # Find the xcframework
          FRAMEWORK_PATH=$(find . -name "TVVLCKit.xcframework" -type d | head -1)

          if [ -z "$FRAMEWORK_PATH" ]; then
            echo "‚ùå TVVLCKit.xcframework not found in download"
            exit 1
          fi

          # Create xcframework zip
          cd $(dirname "$FRAMEWORK_PATH")
          zip -r TVVLCKit.xcframework.zip TVVLCKit.xcframework

          # Calculate checksum
          CHECKSUM=$(swift package compute-checksum TVVLCKit.xcframework.zip)
          echo "Checksum: $CHECKSUM"

          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "framework_path=$(pwd)/TVVLCKit.xcframework.zip" >> $GITHUB_OUTPUT
          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.check-version.outputs.update_available == 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.check-version.outputs.latest_version }}
          release_name: TVVLCKit ${{ steps.check-version.outputs.latest_version }}
          body: |
            Automated update of TVVLCKit framework to version ${{ steps.check-version.outputs.latest_version }}

            Source: https://code.videolan.org/videolan/VLCKit

            **Changes:**
            - Updated TVVLCKit from ${{ steps.check-version.outputs.current_version }} to ${{ steps.check-version.outputs.latest_version }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        if: steps.check-version.outputs.update_available == 'true'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.download.outputs.framework_path }}
          asset_name: TVVLCKit.xcframework.zip
          asset_content_type: application/zip

      - name: Update Package.swift
        if: steps.check-version.outputs.update_available == 'true'
        run: |
          VERSION=${{ steps.check-version.outputs.latest_version }}
          CHECKSUM=${{ steps.download.outputs.checksum }}

          # Update Package.swift with new version and checksum
          sed -i '' "s|download/v[0-9.]*|download/$VERSION|g" Package.swift
          sed -i '' "s|checksum: \"[^\"]*\"|checksum: \"$CHECKSUM\"|g" Package.swift

          echo "‚úÖ Updated Package.swift"
          cat Package.swift

      - name: Create Pull Request
        if: steps.check-version.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update TVVLCKit to ${{ steps.check-version.outputs.latest_version }}"
          title: "üîÑ Update TVVLCKit to ${{ steps.check-version.outputs.latest_version }}"
          body: |
            ## üéâ New TVVLCKit Version Available

            This PR updates the TVVLCKit framework from **${{ steps.check-version.outputs.current_version }}** to **${{ steps.check-version.outputs.latest_version }}**.

            ### Changes
            - ‚úÖ Downloaded latest TVVLCKit framework from VLCKit
            - ‚úÖ Created GitHub release with framework binary
            - ‚úÖ Updated `Package.swift` with new version and checksum

            ### Source
            - [VLCKit Repository](https://code.videolan.org/videolan/VLCKit)
            - [Release ${{ steps.check-version.outputs.latest_version }}](https://code.videolan.org/videolan/VLCKit/-/releases/${{ steps.check-version.outputs.latest_version }})

            ### Testing
            Please test this update in your projects before merging.

            ---
            ü§ñ This PR was automatically created by the Update TVVLCKit workflow.
          branch: update-tvvlckit-${{ steps.check-version.outputs.latest_version }}
          delete-branch: true
          labels: |
            dependencies
            automated
            tvos

      - name: Send notification on update
        if: steps.check-version.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîî TVVLCKit Updated to ${{ steps.check-version.outputs.latest_version }}',
              body: `A new version of TVVLCKit is available and has been automatically updated.

              **Previous version:** ${{ steps.check-version.outputs.current_version }}
              **New version:** ${{ steps.check-version.outputs.latest_version }}

              A pull request has been created with the update. Please review and merge when ready.

              ü§ñ Automated notification from Update TVVLCKit workflow.`,
              labels: ['notification', 'update-available']
            });

      - name: Comment on failure
        if: failure() && steps.check-version.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå TVVLCKit Update Failed',
              body: `The automated TVVLCKit update workflow failed.

              **Attempted version:** ${{ steps.check-version.outputs.latest_version }}

              Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

              ü§ñ Automated notification from Update TVVLCKit workflow.`,
              labels: ['notification', 'error']
            });
